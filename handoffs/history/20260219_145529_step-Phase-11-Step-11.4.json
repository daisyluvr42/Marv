{
  "project": {
    "name": "blackbox-agent-runtime",
    "version": "0.1.0",
    "docs_source_of_truth": [
      "PRD.md",
      "APP_FLOW.md",
      "TECH_STACK.md",
      "FRONTEND_GUIDELINES.md",
      "BACKEND_STRUCTURE.md",
      "IMPLEMENTATION_PLAN.md",
      "SKILL.md"
    ]
  },
  "execution": {
    "mode": "autopilot",
    "current_step": {
      "id": "Phase 11 - Step 11.4",
      "title": "OpenClaw 交互增强（CLI 操作层）",
      "status": "done",
      "acceptance_criteria": [
        "补齐 OpenClaw 风格常用交互（preset/eval/allowlist 同步）",
        "tools exec 在 pending_approval 场景支持即时交互审批",
        "兼容旧策略键位（agents.default）与大小写无关 allowlist 匹配",
        "新增测试覆盖交互增强的关键逻辑"
      ]
    },
    "next_step": {
      "id": "COMPLETED",
      "title": "等待实机权限策略回放",
      "reason": "CLI 交互已进一步对齐 OpenClaw 体验，建议在真实 Telegram/CLI 流程中调优 preset 与 allowlist"
    },
    "constraints": {
      "tech_stack_locked": true,
      "no_editable_bootstrap_files": true,
      "event_sourcing_required": true,
      "atomic_lane_required": true
    }
  },
  "state": {
    "blockers": [],
    "risks": [
      "若 agents.main 仍设置为 full，defaults 的 strict/balanced preset 不会生效到 main actor。",
      "tools exec 的即时审批提示依赖 TTY，非交互环境会直接返回 pending_approval。",
      "allowlist sync-readonly 仅同步当前注册的 read_only 工具，新增工具后需重新同步。"
    ],
    "notes": [
      "本次以“交互操作相似度”为目标，未修改与现有底层机制冲突的核心 RBAC/审批约束。",
      "权限策略文件继续沿用 data/exec-approvals.json。"
    ]
  },
  "artifacts": {
    "changed_files": {
      "added": [
        "handoffs/history/20260219_145529_step-Phase-11-Step-11.4.json"
      ],
      "modified": [
        "README.md",
        "backend/cli.py",
        "backend/permissions/exec_approvals.py",
        "docs/PERMISSIONS.md",
        "tests/test_permissions_exec_approvals.py",
        "HANDOFF.JSON"
      ],
      "deleted": []
    },
    "commands": {
      "setup": [
        "uv sync"
      ],
      "run": [
        "uv run marv permissions --help",
        "uv run marv permissions preset --name balanced",
        "uv run marv permissions allowlist sync-readonly --agent main",
        "uv run marv permissions eval --agent main --tool mock_external_write",
        "uv run marv tools exec --help"
      ],
      "test": [
        "uv run pytest -q"
      ],
      "smoke": [
        "配置 allowlist + ask=on-miss 后执行非 allowlist 工具，观察 pending_approval",
        "在 TTY 执行 marv tools exec --prompt-approval，验证 approve/reject/skip 交互"
      ]
    },
    "api_endpoints_touched": [],
    "db_tables_touched": [],
    "events_emitted": []
  },
  "verification": {
    "status": "passed",
    "results": [
      {
        "name": "backend_tests",
        "status": "passed",
        "output": "uv run pytest -q -> 17 passed"
      },
      {
        "name": "permissions_cli_surface",
        "status": "passed",
        "output": "permissions 新增 eval/preset，allowlist 新增 sync-readonly"
      },
      {
        "name": "permissions_runtime_commands",
        "status": "passed",
        "output": "preset/sync-readonly/eval 命令实际可执行并返回结构化结果"
      }
    ],
    "logs": [
      "新增 OpenClaw 风格 preset 与 eval 交互命令。",
      "tools exec 新增 pending_approval 即时审批提示（TTY 模式）。"
    ]
  },
  "handoff": {
    "summary": "完成一轮程序检查并把 CLI 交互进一步对齐 OpenClaw。",
    "what_was_done": [
      "permissions 增加 preset（strict/balanced/full）",
      "permissions 增加 eval（查看某 actor 对某工具的生效决策）",
      "allowlist 增加 sync-readonly（自动同步 read_only 工具）",
      "tools exec 增加 --prompt-approval 交互式 approve/reject/skip",
      "权限引擎兼容 agents.default -> agents.main，并支持大小写无关 allowlist 匹配"
    ],
    "how_to_verify": [
      "运行：uv run marv permissions preset --name balanced",
      "运行：uv run marv permissions allowlist sync-readonly --agent main",
      "运行：uv run marv permissions eval --agent main --tool mock_external_write",
      "运行：uv run marv tools exec --tool mock_external_write --args '{\"target\":\"file://x\",\"content\":\"abc\"}' --prompt-approval"
    ],
    "known_issues": [
      "OpenClaw 的 askFallback 语义在当前架构下仍未做独立运行态分支（保留字段）。"
    ],
    "rollback_plan": [
      "回退 backend/cli.py、backend/permissions/exec_approvals.py、README.md、docs/PERMISSIONS.md、tests/test_permissions_exec_approvals.py",
      "恢复 HANDOFF.JSON",
      "重新执行 uv run pytest -q"
    ]
  }
}
