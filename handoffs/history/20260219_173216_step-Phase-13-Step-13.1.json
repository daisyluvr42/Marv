{
  "project": {
    "name": "blackbox-agent-runtime",
    "version": "0.1.0",
    "docs_source_of_truth": [
      "PRD.md",
      "APP_FLOW.md",
      "TECH_STACK.md",
      "FRONTEND_GUIDELINES.md",
      "BACKEND_STRUCTURE.md",
      "IMPLEMENTATION_PLAN.md",
      "SKILL.md"
    ]
  },
  "execution": {
    "mode": "autopilot",
    "current_step": {
      "id": "Phase 13 - Step 13.1",
      "title": "P0/P1/P2 全量补齐（记忆闭环+可靠性+可观测性）",
      "status": "done",
      "acceptance_criteria": [
        "P0: 记忆策略参数化、上下文压缩+记忆冲刷、记忆生命周期治理完整可用",
        "P1: provider fallback/retry 矩阵、Telegram pairing、会话隔离工作区可用",
        "P2: IPC 工具桥接和记忆 metrics 看板接口可用",
        "测试回归通过且文档/CLI 已补齐"
      ]
    },
    "next_step": {
      "id": "COMPLETED",
      "title": "等待实机压测和参数收敛",
      "reason": "核心能力已补齐，下一步建议在真实 Telegram 流量下调 memory strictness/top_k/ttl/provider matrix"
    },
    "constraints": {
      "tech_stack_locked": true,
      "no_editable_bootstrap_files": true,
      "event_sourcing_required": true,
      "atomic_lane_required": true
    }
  },
  "state": {
    "blockers": [],
    "risks": [
      "IPC 工具桥接的安全边界由配置和权限策略共同决定，生产环境需审计 command 白名单。",
      "provider matrix 若包含高延迟后备节点，极端故障时总响应时间会拉长。",
      "自动记忆提取为规则引擎，复杂叙述场景仍建议后续升级 LLM 抽取器。"
    ],
    "notes": [
      "记忆检索已升级为向量+词面+置信度混合评分并支持 TTL/半衰期。",
      "external_write 新增会话工作区边界检查。"
    ]
  },
  "artifacts": {
    "changed_files": {
      "added": [
        "backend/agent/session_runtime.py",
        "backend/gateway/pairing.py",
        "backend/tools/ipc_bridge.py",
        "docs/IPC_TOOLS.md",
        "tests/test_core_client_provider_matrix.py",
        "tests/test_ipc_bridge.py",
        "tests/test_telegram_pairing.py",
        "handoffs/history/20260219_173216_step-Phase-13-Step-13.1.json"
      ],
      "modified": [
        ".env.example",
        "README.md",
        "backend/agent/api.py",
        "backend/agent/config.py",
        "backend/agent/processor.py",
        "backend/cli.py",
        "backend/core_client/openai_compat.py",
        "backend/gateway/telegram.py",
        "backend/heartbeat/runtime.py",
        "backend/memory/store.py",
        "backend/patch/state.py",
        "backend/storage/models.py",
        "backend/tools/registry.py",
        "docs/HEARTBEAT.md",
        "docs/TELEGRAM_SETUP.md",
        "tests/test_api_flows.py",
        "tests/test_heartbeat_runtime.py",
        "tests/test_telegram_gateway.py",
        "HANDOFF.JSON"
      ],
      "deleted": []
    },
    "commands": {
      "setup": [
        "uv sync"
      ],
      "run": [
        "uv run marv memory metrics --window-hours 24",
        "uv run marv memory items --scope-type user --scope-id <user_id>",
        "uv run marv system core-providers",
        "uv run marv telegram pair create-code --chat-id <chat_id> --user-id <user_id> --ttl-seconds 900",
        "uv run marv sessions list",
        "uv run marv system ipc-reload"
      ],
      "test": [
        "uv run pytest -q"
      ],
      "smoke": [
        "发送“记住 ...”后再次对话，确认 memory system prompt 自动注入",
        "启用 TELEGRAM_REQUIRE_PAIRING=true 后未配对用户被拦截，/pair 成功后放行",
        "配置 CORE_PROVIDER_MATRIX_JSON 并断开主 provider，确认 fallback provider 接管",
        "配置 data/ipc-tools.json 后运行 system ipc-reload 并执行对应工具"
      ]
    },
    "api_endpoints_touched": [
      "GET /v1/system/core/providers",
      "GET /v1/system/ipc-tools",
      "POST /v1/system/telegram/pairings/codes",
      "GET /v1/system/telegram/pairings",
      "GET /v1/system/telegram/pairings/codes",
      "POST /v1/system/telegram/pairings/{pairing_id}:revoke",
      "GET /v1/agent/sessions",
      "GET /v1/agent/sessions/{conversation_id}",
      "POST /v1/agent/sessions/{conversation_id}:archive",
      "GET /v1/memory/items",
      "POST /v1/memory/items/{item_id}:update",
      "POST /v1/memory/items/{item_id}:delete",
      "POST /v1/memory/forget",
      "POST /v1/memory/decay",
      "GET /v1/memory/metrics"
    ],
    "db_tables_touched": [
      "memory_items",
      "memory_candidates",
      "memory_retrieval_logs",
      "session_workspaces",
      "telegram_pair_codes",
      "telegram_pairings"
    ],
    "events_emitted": []
  },
  "verification": {
    "status": "passed",
    "results": [
      {
        "name": "backend_tests",
        "status": "passed",
        "output": "uv run pytest -q -> 32 passed"
      },
      {
        "name": "python_compile",
        "status": "passed",
        "output": "新增/修改 Python 文件 py_compile 通过"
      },
      {
        "name": "memory_regression",
        "status": "passed",
        "output": "新增 memory lifecycle/session/pairing/ipc/provider 测试通过"
      }
    ],
    "logs": [
      "P0/P1/P2 能力均已打通并可通过 CLI/API 调用。"
    ]
  },
  "handoff": {
    "summary": "已按要求完成 P0->P1->P2 全量补齐，记忆处理能力已升级为自动闭环并保留结构化存储优势。",
    "what_was_done": [
      "P0: memory 策略参数化（strictness/top_k/min_score/TTL/half-life/always_include_user_memory）",
      "P0: conversation compaction flush（周期性摘要写入 conversation_summary 记忆）",
      "P0: memory lifecycle API/CLI（items/update/delete/forget/decay/metrics）",
      "P1: Core provider fallback matrix（CORE_PROVIDER_MATRIX_JSON）",
      "P1: Telegram pairing（配对码生成/核销/撤销）",
      "P1: 会话工作区隔离（session workspace + external_write 边界检查）",
      "P2: IPC tools bridge（data/ipc-tools.json 动态注册）",
      "P2: memory retrieval metrics 日志与聚合查询"
    ],
    "how_to_verify": [
      "运行：uv run pytest -q",
      "运行：uv run marv memory metrics --window-hours 24",
      "运行：uv run marv system core-providers",
      "运行：uv run marv telegram pair create-code --chat-id <chat_id> --user-id <user_id>",
      "运行：uv run marv sessions list",
      "运行：uv run marv system ipc-reload"
    ],
    "known_issues": [
      "IPC bridge 当前为 JSON stdin/stdout 协议，未实现完整 MCP transport。"
    ],
    "rollback_plan": [
      "回退本次新增/修改文件并恢复 HANDOFF.JSON",
      "重新执行 uv run pytest -q"
    ]
  }
}
