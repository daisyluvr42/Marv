{
  "project": {
    "name": "blackbox-agent-runtime",
    "version": "0.1.0",
    "docs_source_of_truth": [
      "PRD.md",
      "APP_FLOW.md",
      "TECH_STACK.md",
      "FRONTEND_GUIDELINES.md",
      "BACKEND_STRUCTURE.md",
      "IMPLEMENTATION_PLAN.md",
      "SKILL.md"
    ]
  },
  "execution": {
    "mode": "autopilot",
    "current_step": {
      "id": "Phase 11 - Step 11.5",
      "title": "APScheduler/cron 周期心跳机制（OpenClaw 对齐）",
      "status": "done",
      "acceptance_criteria": [
        "Edge 启动后使用 APScheduler 运行周期心跳任务",
        "初始化时可通过环境变量设定默认心跳配置",
        "运行后可通过 API/CLI 修改心跳配置并热更新",
        "心跳任务可执行 Core 探活与审批后待执行工具恢复"
      ]
    },
    "next_step": {
      "id": "COMPLETED",
      "title": "等待实机运行参数调优",
      "reason": "心跳机制已切换为 OpenClaw 风格并支持运行期配置；下一步是根据真实负载调 interval/cron"
    },
    "constraints": {
      "tech_stack_locked": true,
      "no_editable_bootstrap_files": true,
      "event_sourcing_required": true,
      "atomic_lane_required": true
    }
  },
  "state": {
    "blockers": [],
    "risks": [
      "心跳频率过高会增加 ledger 写入与 Core 探活压力。",
      "cron 模式表达式配置错误会导致任务不触发或触发异常（建议先用 interval）。",
      "resume_approved_tools_enabled 开启后会周期扫描 pending_approval，需保证审批语义符合预期。"
    ],
    "notes": [
      "首次启动若不存在 heartbeat 配置文件，会按环境变量生成 data/heartbeat-config.json。",
      "heartbeat set 通过 API 热更新配置并重载调度器。"
    ]
  },
  "artifacts": {
    "changed_files": {
      "added": [
        "backend/heartbeat/__init__.py",
        "backend/heartbeat/runtime.py",
        "docs/HEARTBEAT.md",
        "tests/test_heartbeat_runtime.py",
        "handoffs/history/20260219_151459_step-Phase-11-Step-11.5.json"
      ],
      "modified": [
        ".env.example",
        "README.md",
        "backend/agent/api.py",
        "backend/cli.py",
        "backend/ledger/events.py",
        "tests/conftest.py",
        "tests/test_api_flows.py",
        "HANDOFF.JSON"
      ],
      "deleted": []
    },
    "commands": {
      "setup": [
        "uv sync"
      ],
      "run": [
        "uv run marv heartbeat --help",
        "uv run marv heartbeat show",
        "uv run marv heartbeat set --mode interval --interval-seconds 45",
        "uv run marv heartbeat set --mode cron --cron \"*/3 * * * *\""
      ],
      "test": [
        "uv run pytest -q"
      ],
      "smoke": [
        "启动 edge 后调用 GET /v1/system/heartbeat 查看 jobs 与 config",
        "调用 POST /v1/system/heartbeat/config 修改 interval_seconds 并观察 scheduler 重载",
        "检查 audit timeline(system:heartbeat) 确认 HeartbeatEvent 周期写入（emit_events=true 时）"
      ]
    },
    "api_endpoints_touched": [
      "GET /v1/system/heartbeat",
      "POST /v1/system/heartbeat/config"
    ],
    "db_tables_touched": [
      "ledger_events（新增 HeartbeatEvent 写入）"
    ],
    "events_emitted": [
      "HeartbeatEvent"
    ]
  },
  "verification": {
    "status": "passed",
    "results": [
      {
        "name": "backend_tests",
        "status": "passed",
        "output": "uv run pytest -q -> 20 passed"
      },
      {
        "name": "cli_surface",
        "status": "passed",
        "output": "marv --help 显示 heartbeat 子命令；heartbeat --help 正常"
      },
      {
        "name": "api_heartbeat_flow",
        "status": "passed",
        "output": "新增 test_heartbeat_config_owner_update 覆盖 owner 更新与 member 禁止更新"
      }
    ],
    "logs": [
      "引入 APScheduler（interval/cron）驱动周期任务。",
      "心跳任务包含 Core 探活与审批后待执行工具恢复。",
      "新增 heartbeat 配置持久化文件与热更新 API/CLI。"
    ]
  },
  "handoff": {
    "summary": "已将心跳机制切换为 OpenClaw 风格 APScheduler/cron，并支持初始化配置与运行后修改。",
    "what_was_done": [
      "新增 backend.heartbeat.runtime：配置加载、调度器生命周期、周期心跳任务",
      "Edge lifespan 接入 heartbeat_runtime.start/stop",
      "新增 HeartbeatEvent 并写入 ledger",
      "新增系统 API：/v1/system/heartbeat 与 /v1/system/heartbeat/config",
      "新增 CLI：marv heartbeat show/set",
      "更新 .env.example 与 HEARTBEAT 文档",
      "补充测试：heartbeat 运行配置与 API 权限验证"
    ],
    "how_to_verify": [
      "启动服务后运行：uv run marv heartbeat show",
      "运行：uv run marv heartbeat set --mode interval --interval-seconds 30",
      "运行：uv run marv heartbeat set --mode cron --cron \"*/2 * * * *\"",
      "运行：uv run pytest -q"
    ],
    "known_issues": [
      "非交互 CLI 且 Edge 未启动时，heartbeat 命令会返回连接失败。"
    ],
    "rollback_plan": [
      "移除 backend/heartbeat/ 与 docs/HEARTBEAT.md、tests/test_heartbeat_runtime.py",
      "回退 backend/agent/api.py、backend/cli.py、backend/ledger/events.py、README.md、.env.example、tests 相关改动",
      "恢复 HANDOFF.JSON 后重新执行 uv run pytest -q"
    ]
  }
}
