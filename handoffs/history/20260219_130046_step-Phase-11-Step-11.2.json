{
  "project": {
    "name": "blackbox-agent-runtime",
    "version": "0.1.0",
    "docs_source_of_truth": [
      "PRD.md",
      "APP_FLOW.md",
      "TECH_STACK.md",
      "FRONTEND_GUIDELINES.md",
      "BACKEND_STRUCTURE.md",
      "IMPLEMENTATION_PLAN.md",
      "SKILL.md"
    ]
  },
  "execution": {
    "mode": "autopilot",
    "current_step": {
      "id": "Phase 11 - Step 11.2",
      "title": "CLI Ops 菜单（迁移打包 + 停服务确认）",
      "status": "done",
      "acceptance_criteria": [
        "CLI 提供一键迁移打包命令",
        "CLI 提供停止现有服务命令",
        "两个命令都要求用户明确确认",
        "打包结果可用于跨机器恢复"
      ]
    },
    "next_step": {
      "id": "COMPLETED",
      "title": "等待新机器迁移实测",
      "reason": "CLI 运维菜单已就位，下一步是在目标机器执行迁移恢复并验证 Telegram/CLI 实际行为"
    },
    "constraints": {
      "tech_stack_locked": true,
      "no_editable_bootstrap_files": true,
      "event_sourcing_required": true,
      "atomic_lane_required": true
    }
  },
  "state": {
    "blockers": [],
    "risks": [
      "迁移包包含完整 edge.db，可能含对话与审计数据，需安全传输与妥善保管。",
      "若不先停服务直接打包，SQLite 仍可能在写入，建议先执行 marv ops stop-services。",
      "stop-services 依赖 scripts/stop_stack.sh，若脚本被删改将导致命令失败。"
    ],
    "notes": [
      "新增 marv ops 子命令组，面向本地运维动作。",
      "ops 命令无需 Edge API 在线。"
    ]
  },
  "artifacts": {
    "changed_files": {
      "added": [
        "tests/test_cli_ops.py",
        "handoffs/history/20260219_130046_step-Phase-11-Step-11.2.json"
      ],
      "modified": [
        "README.md",
        "backend/cli.py",
        "HANDOFF.JSON"
      ],
      "deleted": []
    },
    "commands": {
      "setup": [
        "uv sync"
      ],
      "run": [
        "uv run marv --help",
        "printf 'YES\\n' | uv run marv ops package-migration --output-dir /tmp/marv_migrations",
        "printf 'NO\\n' | uv run marv ops stop-services"
      ],
      "test": [
        "uv run pytest -q"
      ],
      "smoke": [
        "printf 'YES\\n' | uv run marv ops package-migration --output-dir ./dist/migrations",
        "tar -tzf ./dist/migrations/<bundle>.tar.gz | head"
      ]
    },
    "api_endpoints_touched": [],
    "db_tables_touched": [],
    "events_emitted": []
  },
  "verification": {
    "status": "passed",
    "results": [
      {
        "name": "backend_tests",
        "status": "passed",
        "output": "uv run pytest -q -> 10 passed"
      },
      {
        "name": "cli_help",
        "status": "passed",
        "output": "marv --help 显示新增 ops 菜单"
      },
      {
        "name": "ops_package",
        "status": "passed",
        "output": "确认后成功输出迁移包到 /tmp/marv_migrations"
      },
      {
        "name": "ops_stop_confirmation",
        "status": "passed",
        "output": "输入 NO 时命令中止并返回 operation canceled"
      }
    ],
    "logs": [
      "新增 backend.cli 本地运维功能：migration tarball + stop services。",
      "命令执行前均要求输入 YES 确认。"
    ]
  },
  "handoff": {
    "summary": "已在 CLI 增加可交互确认的一键迁移打包与停服务菜单。",
    "what_was_done": [
      "新增 marv ops package-migration：从 edge.db 生成 tar.gz 迁移包（含 manifest）",
      "新增 marv ops stop-services：调用 scripts/stop_stack.sh 停止 core/edge/telegram",
      "新增确认机制：必须输入 YES 才会执行运维动作",
      "新增 tests/test_cli_ops.py 验证迁移包结构与 manifest"
    ],
    "how_to_verify": [
      "运行：uv run marv --help",
      "运行：printf 'YES\\n' | uv run marv ops package-migration --output-dir ./dist/migrations",
      "运行：printf 'NO\\n' | uv run marv ops stop-services"
    ],
    "known_issues": [
      "ops package-migration 当前不自动停服务，需先手动执行 ops stop-services 以降低数据不一致风险。"
    ],
    "rollback_plan": [
      "回退 backend/cli.py 与 README.md，删除 tests/test_cli_ops.py",
      "恢复 HANDOFF.JSON",
      "重新执行 uv run pytest -q"
    ]
  }
}
