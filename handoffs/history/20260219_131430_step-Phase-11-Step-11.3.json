{
  "project": {
    "name": "blackbox-agent-runtime",
    "version": "0.1.0",
    "docs_source_of_truth": [
      "PRD.md",
      "APP_FLOW.md",
      "TECH_STACK.md",
      "FRONTEND_GUIDELINES.md",
      "BACKEND_STRUCTURE.md",
      "IMPLEMENTATION_PLAN.md",
      "SKILL.md"
    ]
  },
  "execution": {
    "mode": "autopilot",
    "current_step": {
      "id": "Phase 11 - Step 11.3",
      "title": "OpenClaw 风格权限机制（CLI 可配置）",
      "status": "done",
      "acceptance_criteria": [
        "提供 OpenClaw 风格 security/ask/allowlist 策略模型",
        "CLI 提供权限查看与设置菜单",
        "工具执行链路接入权限策略并支持 deny/ask/allow",
        "ask 命中时返回 pending_approval"
      ]
    },
    "next_step": {
      "id": "COMPLETED",
      "title": "等待权限策略实机调优",
      "reason": "权限策略与 CLI 菜单已落地，下一步可按实际工作流调整 allowlist 与 actor 策略"
    },
    "constraints": {
      "tech_stack_locked": true,
      "no_editable_bootstrap_files": true,
      "event_sourcing_required": true,
      "atomic_lane_required": true
    }
  },
  "state": {
    "blockers": [],
    "risks": [
      "策略若配置过严（例如 defaults.security=deny）会导致工具请求全部被拒绝。",
      "allowlist 模式依赖模式匹配，工具名变更后可能导致策略 miss。",
      "当前权限策略主要作用于 tools:execute，其余能力仍由 RBAC + 现有审批流控制。"
    ],
    "notes": [
      "策略文件默认路径为 data/exec-approvals.json，可通过 EDGE_EXEC_APPROVALS_PATH 覆盖。",
      "默认策略保持向后兼容：security=full, ask=off。"
    ]
  },
  "artifacts": {
    "changed_files": {
      "added": [
        "backend/permissions/__init__.py",
        "backend/permissions/exec_approvals.py",
        "docs/PERMISSIONS.md",
        "tests/test_permissions_exec_approvals.py",
        "handoffs/history/20260219_131430_step-Phase-11-Step-11.3.json"
      ],
      "modified": [
        "README.md",
        "backend/agent/api.py",
        "backend/cli.py",
        "tests/test_api_flows.py",
        "HANDOFF.JSON"
      ],
      "deleted": []
    },
    "commands": {
      "setup": [
        "uv sync"
      ],
      "run": [
        "uv run marv permissions --help",
        "uv run marv permissions show",
        "uv run marv permissions set-default --security allowlist --ask on-miss --ask-fallback deny",
        "uv run marv permissions allowlist add --agent main --pattern mock_web_search"
      ],
      "test": [
        "uv run pytest -q"
      ],
      "smoke": [
        "设置 defaults=allowlist + ask=off 且不包含某工具后调用 /v1/tools:execute 预期 403",
        "设置 defaults=allowlist + ask=on-miss 后调用 /v1/tools:execute 预期 pending_approval"
      ]
    },
    "api_endpoints_touched": [
      "POST /v1/tools:execute"
    ],
    "db_tables_touched": [],
    "events_emitted": []
  },
  "verification": {
    "status": "passed",
    "results": [
      {
        "name": "backend_tests",
        "status": "passed",
        "output": "uv run pytest -q -> 15 passed"
      },
      {
        "name": "permissions_cli_help",
        "status": "passed",
        "output": "marv permissions 与 allowlist 子命令帮助可用"
      },
      {
        "name": "permissions_cli_update",
        "status": "passed",
        "output": "set-default/allowlist add/show 命令可写入并读取策略文件"
      }
    ],
    "logs": [
      "新增 backend.permissions.exec_approvals 策略引擎。",
      "tools:execute 接入权限决策，deny 返回 403，ask 进入 pending_approval。"
    ]
  },
  "handoff": {
    "summary": "已实现 OpenClaw 风格权限机制，并提供 CLI 菜单进行策略管理。",
    "what_was_done": [
      "新增执行权限策略模型（security/ask/ask_fallback/allowlist）",
      "新增 marv permissions 菜单：show/set-default/set-agent/unset-agent/allowlist add|remove",
      "在 tools:execute 上接入策略决策（allow/ask/deny）",
      "新增单测覆盖策略决策与 API 行为"
    ],
    "how_to_verify": [
      "运行：uv run marv permissions show",
      "运行：uv run marv permissions set-default --security allowlist --ask on-miss --ask-fallback deny",
      "运行：uv run marv permissions allowlist add --agent main --pattern mock_web_search",
      "运行：uv run pytest -q"
    ],
    "known_issues": [
      "当前 ask_fallback 字段为兼容保留，尚未区分交互可用性场景。"
    ],
    "rollback_plan": [
      "删除 backend/permissions/ 与相关测试文件",
      "回退 backend/agent/api.py、backend/cli.py、README.md、HANDOFF.JSON",
      "重新运行 uv run pytest -q"
    ]
  }
}
